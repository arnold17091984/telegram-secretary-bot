# Telegram Secretary Bot - TODO List

## Phase 1: プロジェクト初期化とTODOリスト作成
- [x] プロジェクト初期化
- [x] TODOリスト作成

## Phase 2: データベーススキーマ設計と実装
- [x] Tasksテーブルの作成
- [x] Meetingsテーブルの作成
- [x] Meeting_Attendeesテーブルの作成
- [x] Draftsテーブルの作成
- [x] Audit_Logsテーブルの作成
- [x] Bot_Settingsテーブルの作成（Telegram Bot Token、API設定など）
- [x] Group_Chatsテーブルの作成（グループチャット管理）
- [x] Reminder_Settingsテーブルの作成（リマインド設定）
- [x] データベースマイグレーション実行

## Phase 3: 管理画面のデザインとレイアウト構築
- [x] エレガントなカラーパレット設定（index.css）
- [x] DashboardLayoutの実装
- [x] サイドバーナビゲーションの実装
- [x] ダッシュボードホーム画面の実装

## Phase 4: 管理画面の設定管理機能実装
- [x] API設定画面の実装（Telegram Bot Token、OpenAI API Key、Google Calendar認証情報）
- [x] グループチャット管理画面の実装（追加・編集・削除）
- [x] 管理者ユーザーID設定画面の実装
- [x] リマインド設定画面の実装（間隔・期限超過フォロー設定）
- [x] AIモデル設定画面の実装（model名、temperature、max_tokens）

## Phase 5: 管理画面のデータ閲覧機能実装
- [ ] タスク一覧画面の実装（フィルタリング・検索機能）
- [ ] ミーティング一覧画面の実装（フィルタリング・検索機能）
- [ ] 監査ログ閲覧画面の実装（フィルタリング機能）
- [ ] ダッシュボード統計表示の実装

## Phase 6: Telegram Bot Webhook受信とルーティング実装
- [x] Telegram Webhook受信エンドポイントの実装
- [x] メッセージパーサーの実装
- [x] トリガー検知ロジックの実装（【タスク】【ミーティング】【AI】【返答】）
- [x] インラインボタンコールバック処理の実装

## Phase 7: タスク管理機能の実装
- [x] 【タスク】トリガー検知と仮登録処理
- [x] 担当者への期限設定ボタン送信機能
- [x] 期限選択処理（今日中、明日、3日後、日付指定、質問、却下）
- [x] タスク状態管理（pending_acceptance、in_progress、blocked、completed）
- [x] タスク確定メッセージ投稿機能
- [x] 進行中・ブロック・完了・期限変更ボタンの実装

## Phase 8: ミーティング管理機能の実装
- [x] 【ミーティング】トリガー検知と日時・参加者パース
- [x] 不足情報確認ボタンの実装
- [x] オンライン会議確認ボタンの実装（Google Meet、対面、その他）
- [x] Google Calendar API連携の実装
- [x] カレンダーイベント作成とMeetリンク生成
- [x] グループチャットへのミーティング登録メッセージ投稿
- [x] ミーティング開始10分前リマインド機能

## Phase 9: AI下書き生成機能の実装
- [x] 【AI】トリガー検知と権限チェック
- [x] 直近50件のチャット履歴収集ロジック
- [x] OpenAI API呼び出しと下書き生成
- [x] 管理者DMへの下書き送信（投稿・編集・破棄ボタン付き）
- [x] グループチャット選択と投稿機能
- [x] 【返答】トリガー検知と未回答質問抽出ロジック
- [x] 質問選択フローの実装
- [x] 返答下書き生成と投稿機能

## Phase 10: リマインダーとジョブキューの実装
- [x] Redis + BullMQのセットアップ
- [x] タスク期限24時間前リマインドジョブ
- [x] タスク期限1時間前リマインドジョブ
- [x] タスク期限超過フォロージョブ（段階的エスカレーション）
- [x] 未回答質問72時間リマインドジョブ
- [x] ミーティング10分前リマインドジョブ
## Phase 11: 統合テストと動作確認
- [x] タスク作成から完了までのフローテスト
- [x] ミーティング作成からリマインドまでのフローテスト
- [x] AI下書き生成から投稿までのフローテスト
- [x] 全APIエンドポイントの動作確認
- [x] 管理画面の全機能テスト
- [ ] 管理画面の全機能動作確認

## Phase 12: 成果物の提供とデプロイ手順の説明
- [x] チェックポイント作成
- [x] デプロイ手順書の作成
- [x] ユーザーマニュアルの作成成
- [ ] ユーザーへの成果物提供

## 追加要望: UI日本語化
- [x] DashboardLayoutのナビゲーションメニューを日本語化
- [x] 全ページのタイトルとラベルを日本語化
- [x] ボタンテキストを日本語化
- [x] フォームのプレースホルダーを日本語化

## 追加要望: 設定画面の入力フォーム実装
- [x] API設定の入力フォーム（Telegram Bot Token、OpenAI API Key、Google Calendar認証情報）
- [x] グループチャット管理の追加・編集・削除フォーム
- [x] リマインダー設定の入力フォーム
- [x] AIモデル設定の入力フォーム
- [x] tRPC APIとの連携

## 追加要望: 設定の永続化とテスト機能
- [ ] 設定の初期値読み込み（データベースから既存設定を取得）
- [ ] パスワード目隠しボタンの実装（Token、API Keyの表示/非表示切り替え）
- [ ] Telegram Bot Token接続テスト機能
- [ ] OpenAI API Key接続テスト機能
- [ ] Google Calendar API接続テスト機能
- [ ] テスト結果の表示（成功/失敗メッセージ）

設定の永続化とテスト機能 - 完了

## 追加要望: 管理画面からのWebhook URL登録機能
- [x] Webhook URL自動登録APIの実装
- [x] Webhook状態確認APIの実装
- [x] Webhook削除APIの実装
- [x] 設定画面にWebhook管理セクションを追加
- [x] ワンクリックでWebhook URL登録ボタン
- [x] 現在のWebhook状態表示

## 追加要望: AI下書き生成フローの改善
- [x] グループチャットへの「AI下書きを生成しました。DMをご確認ください。」メッセージを削除
- [x] 投稿ボタン: 元のグループチャットに下書き内容を即座に投稿
- [x] 編集ボタン: 現在の内容を表示し、編集後に投稿ボタンで投稿
- [x] 破棄ボタン: 下書きを削除し、「破棄しました」と返信
- [ ] 【返答】トリガーも同様のフローに修正

## 追加要望: トリガー管理機能
- [x] トリガー設定画面の作成（設定ページに新しいタブを追加）
- [x] トリガーキーワードの編集機能（【タスク】【ミーティング】【AI】【返答】をカスタマイズ可能に）
- [x] 各トリガーの動作フロー説明の表示
- [x] トリガーの有効/無効切り替え機能
- [x] データベースにtriggersテーブルを追加
- [ ] Webhook処理でデータベースからトリガー設定を読み込むように変更
- [ ] トリガーテスト機能（管理画面から動作確認）

## 追加要望: トリガーページを左サイドバーに移動
- [x] トリガー管理を設定タブから独立したページに変更
- [x] DashboardLayoutのナビゲーションメニューに「トリガー」を追加
- [x] Triggersページを作成（/triggersルート）
- [x] App.tsxにルートを追加
- [x] Settings.tsxからトリガータブを削除

## 追加要望: トリガー追加機能
- [x] トリガー管理画面に「新しいトリガーを追加」ボタンを追加
- [x] トリガー追加ダイアログの実装（キーワード、タイプ、説明の入力フォーム）
- [x] カスタムトリガーの作成機能

## 追加要望: デフォルトトリガーの自動登録
- [x] デフォルトトリガー初期化スクリプトの作成
- [x] サーバー起動時にデフォルトトリガーを自動登録
- [x] トリガーが空の場合のみ初期化を実行

## バグ修正: AI設定のシステムプロンプトが反映されない
- [x] Webhook処理でAI下書き生成時にデータベースからAI設定を読み込む
- [x] システムプロンプトをLLM呼び出しに渡す
- [x] Temperature、Max Tokensなどのパラメータも反映（注: invokeLLMがサポートしていない場合はデフォルト値を使用）

## バグ修正: システムプロンプトが実際に反映されていない
- [x] 設定画面でのAI設定保存形式を確認
- [x] Webhook処理でのAI設定読み込みロジックをデバッグ
- [x] システムプロンプトのキー名が一致しているか確認
- [x] 実際のLLM呼び出しでシステムプロンプトが使用されているか確認

## バグ修正: システムプロンプトが依然として反映されていない
- [x] Webhook処理のログを確認してシステムプロンプトが読み込まれているか確認
- [x] LLM呼び出し時のメッセージ内容をログ出力
- [x] 設定画面で保存したプロンプトがデータベースに正しく保存されているか確認
- [x] データベースから読み込んだプロンプトが正しくLLMに渡されているか確認
- [x] ユーザーメッセージの前置きを削除してシステムプロンプトの効果を強化

## バグ修正: 設定画面のAIモデルが使用されていない
- [x] OpenAI API直接呼び出し関数を作成
- [x] Webhook処理で設定画面のOpenAI API Keyを使用
- [x] 設定画面で選択したモデル（ai_model）を使用
- [x] Temperature、Max Tokensも設定値を反映
- [x] invokeLLMの代わりにOpenAI APIを直接呼び出す

## 新規バグ修正（2026-01-28）

- [x] 「無効な下書きIDです。」エラーを修正（投稿・編集・破棄ボタン押下時）
- [x] システムプロンプトが実際のAI生成に反映されない問題を修正（OpenAI API呼び出しの検証）
  * OpenAI APIは正しく呼ばれている（デバッグログ追加で確認可能）
  * システムプロンプトの内容を強化する必要がある（「**」禁止、冒頭挨拶削除、説明口調回避など）

## 新機能: Claude API統合（2026-01-28）

- [x] Claude API統合モジュールの作成（server/integrations/claude.ts）
- [x] 設定画面にAPIプロバイダー選択機能を追加（OpenAI / Claude）
- [x] Claude API Key設定フィールドを追加
- [x] Claude APIモデル選択（claude-3-5-sonnet-20241022, claude-3-5-haiku-20241022など）
- [x] Webhook処理でAPIプロバイダーを動的に切り替え
- [ ] Claude API接続テスト機能を追加（将来の機能強化）

## バグ修正: Claude APIプロバイダー選択時にGPT-4モデルが渡される（2026-01-28）

- [x] APIプロバイダー変更時にモデル名を自動的にデフォルト値に更新
- [x] OpenAI選択時: gpt-4o（デフォルト）
- [x] Claude選択時: claude-3-5-sonnet-20241022（デフォルト）
- [x] 設定保存時にAPIプロバイダーとモデル名の整合性を確認

## バグ修正: Claude APIモデル名エラー（2026-01-28）

- [x] Claude APIの正しいモデル名を確認
  * Claude Sonnet 4.5: claude-sonnet-4-5-20250929
  * Claude Sonnet 3.7: claude-3-7-sonnet-20250219
  * Claude Haiku 4.5: claude-haiku-4-5-20251001
  * Claude Haiku 3: claude-3-haiku-20240307
- [x] 設定画面のモデル選択肢を修正
- [x] APIプロバイダー変更時のデフォルトモデル名を修正

## システムプロンプト改善（2026-01-28）

- [x] システムプロンプトに出力形式の制約を追加
  * Markdown強調記号（**、__、*、_）を禁止
  * 冒頭挨拶（承知いたしました、かしこまりました）を禁止
  * 提案型表現（もし〜でしたら、お気軽に、何か関連する情報が必要でしたら）を禁止

## 新機能・バグ修正（2026-01-28）

### バグ修正: 「編集」ボタンが動作しない
- [x] 「編集」ボタン押下時に編集画面が表示されない問題を調査
- [x] handleDraftAction関数のeditアクション処理を修正
- [x] draftsテーブルにstatus="editing"を追加
- [x] DMメッセージで編集中の下書きを更新する機能を追加

### 新機能: Web検索API統合（最新情報取得）
- [x] Web検索API（Perplexity API）を統合
- [x] AI生成前にリアルタイム情報を取得
- [x] 設定画面にWeb検索有効化トグルとPerplexity API Key入力フィールドを追加
- [x] 検索結果をコンテキストとしてAIに渡す

## 無料Web検索API統合（2026-01-28）

- [x] 有料のPerplexity APIを無料のWeb検索APIに置き換え
- [x] SearXNG + DuckDuckGoフォールバック統合（APIキー不要）
- [x] 設定画面からPerplexity API Key入力フィールドを削除
- [x] Web検索有効化トグルのみで動作するように変更
- [x] 設定画面でWeb検索説明文を「無料・APIキー不要」に更新

## バグ修正: AI生成結果の問題（2026-01-28 15:01）

- [x] Markdown強調記号（**）が依然として使用されている問題を修正（ポストプロセスで削除）
- [x] 禁止フレーズ（「何か関連して確認したいことはありますか？」）が使用されている問題を修正（ポストプロセスで削除）
- [x] システムプロンプトの制約がAI生成に反映されない根本原因を調査（強制制約追加）
- [x] Web検索結果が正しくAIに渡されているか確認（条件付き実行に変更）

## 機能改善: Web検索の条件付き実行（2026-01-28）

- [x] 最新情報が必要な質問のみWeb検索を実行する判定ロジックを実装
- [x] 判定キーワード: 「最新」「今」「現在」「2024年」「2025年」「2026年」「ニュース」「速報」など
- [x] それ以外の質問はClaude APIのみで回答（高精度な推論を活用）
- [x] Webhook処理に判定ロジックを組み込み

## 機能改善: AIトリガーをメンションに変更（2026-01-28）

- [x] 「【AI】」トリガーに加えて、ボットへのメンション（@ボット名）でもAI機能を実行
- [x] Telegram APIからボットのusernameを取得してメンション検出
- [x] メンション部分を除去してクエリを抽出

## 新機能: リマインド機能（2026-01-28）

- [x] データベースにremindersテーブルを追加（chatId, userId, message, remindAt, status）
- [x] リマインダーの作成・取得・更新のDB操作を実装
- [x] AIがリマインダーを設定できるツール（Function Calling）を実装
- [x] スケジューラーで定期的にリマインダーをチェックして通知を送信
- [ ] 管理画面でリマインダー一覧を表示・管理

## 新機能: 繰り返しリマインダー（2026-01-28）

- [x] remindersテーブルに繰り返し設定フィールドを追加（repeatType, repeatDays, repeatEndDate）
- [x] AI Function Callingに繰り返しパラメータを追加（daily, weekly, monthly）
- [x] 繰り返しリマインダーの次回実行日計算ロジックを実装
- [x] スケジューラーで繰り返しリマインダーを処理（送信後に次回日時を更新）
- [x] 「毎日」「毎週月曜日」「毎月1日」などの自然言語パース

## 新機能: リマインダー管理画面（2026-01-28）

- [x] tRPC APIにリマインダー一覧取得エンドポイントを追加
- [x] tRPC APIにリマインダー更新エンドポイントを追加
- [x] tRPC APIにリマインダー削除エンドポイントを追加
- [x] リマインダー一覧ページを作成（Reminders.tsx）
- [x] リマインダー編集ダイアログを実装
- [x] リマインダー削除確認ダイアログを実装
- [x] DashboardLayoutにリマインダーメニューを追加
- [x] App.tsxにルートを追加

## 機能改善: Google Meet選択時に自動リンク発行（2026-01-28）

- [x] 現在のミーティングフローを確認
- [x] データベースにGoogle認証情報テーブルを追加
- [x] 管理画面の設定ページにGoogle Calendar設定タブを追加
- [x] Google OAuthフローを実装（認証・トークン保存）
- [x] Google Calendar API統合を実装（Meetリンク自動生成）
- [x] 「Google Meet」ボタン選択時に即座にMeetリンクを発行
- [x] 発行したリンクをチャットに送信
- [x] ミーティング情報にMeetリンクを保存

## バグ修正: Googleアカウント連携ができない（2026-01-28）

- [ ] Google OAuth認証フローの問題を調査
- [ ] リダイレクトURIの設定を確認
- [ ] OAuthコールバック処理を確認
- [ ] エラーメッセージを確認して原因を特定


## 機能改善: 現在時刻取得ツールとタイムゾーン設定（2026-01-28）

- [x] AIに現在時刻取得ツール（Function Calling）を追加
- [x] タイムゾーン設定をデータベースに追加（デフォルト: フィリピン時間 UTC+8）
- [x] 「3分後」「1時間後」などの相対時刻を正しく計算
- [x] 「今何時？」の質問に現在時刻で回答
- [x] 管理画面にタイムゾーン設定を追加
- [x] リマインダーの時刻計算をタイムゾーン対応に修正

## バグ修正: リマインダーが実際に設定されない（2026-01-28）

- [ ] isReminderRequest関数の判定条件を確認
- [ ] 「3分後にリマインダー」がリマインダーリクエストとして検出されるか確認
- [ ] Claude APIでのツール呼び出しが正しく動作するか確認
- [ ] リマインダー設定後の確認メッセージが送信されるか確認


## 機能改善: ミーティング確認メッセージのフォーマット改善（2026-01-28）

- [x] Google Meetリンク作成後のメッセージを整理されたフォーマットに変更
- [x] 参加者名を明記（@ユーザー名 → 名前）
- [x] 日時を見やすく表示
- [x] ミーティングリンクを含む完成されたサマリーを表示


## 機能改善: ミーティングメッセージに秘書らしい一言とタイムゾーン追加（2026-01-28）

- [x] 秘書らしい丁寧な一言メッセージを追加（「15分前にリマインドします」など）
- [x] 日時にタイムゾーン表記を追加（フィリピン時間など）


## 機能追加: ミーティング15分前リマインダー自動設定（2026-01-28）

- [x] ミーティング作成時に15分前のリマインダーを自動登録
- [x] リマインダーメッセージを秘書らしいテンプレートに改善
- [x] ミーティング情報（日時、参加者、Meetリンク）をリマインダーメッセージに含める


## バグ修正: リマインダー通知メッセージを自然な文章に修正（2026-01-28）

- [x] 「○○の0分前です！」→「○○のお時間です」に修正
- [x] リマインダーメッセージを秘書らしい自然な文章に改善


## 機能追加: 双方向翻訳機能（2026-01-28） - 完了

- [x] 翻訳セッションテーブルをデータベースに追加
- [x] 翻訳開始/終了キーワードの設定機能
- [x] @メンション時の自動言語検出と翻訳
- [x] 双方向翻訳（相手の言語→日本語、日本語→相手の言語）
- [x] 対応言語: 日本語、英語、中国語、韓国語、タガログ語、タグリッシュ
- [x] 管理画面での翻訳設定UI追加


## 機能改善: 翻訳メッセージのフォーマット修正（2026-01-28） - 完了

- [x] 翻訳結果の言語表示（🌐 日本語 → 英語）を削除
- [x] 翻訳結果のみをシンプルに表示


## 機能改善: 翻訳の自動言語検出（2026-01-28） - 完了

- [x] 相手のメッセージから言語を自動検出する機能を追加
- [x] 言語選択ボタンを不要にする
- [x] 日本語以外のメッセージは日本語に、日本語のメッセージは相手の言語に翻訳


## 機能改善: 他ユーザーのメッセージも翻訳（2026-01-28） - 完了

- [x] 翻訳モード中は他のユーザーのメッセージも日本語に翻訳
- [x] 翻訳セッションをチャット単位で管理（セッションオーナーのために他ユーザーのメッセージも翻訳）


## 機能改善: 最後に検出された言語を記憶（2026-01-28） - 完了

- [x] 他ユーザーのメッセージから検出した言語を常に更新
- [x] セッションオーナーの日本語は最後に検出された言語に翻訳


## 機能追加: チャットID確認機能（2026-01-28） - 完了

- [x] /chatid または 【チャットID】コマンドでグループのチャットIDを表示
- [x] チャットタイプ（グループ、スーパーグループ、プライベート）も表示
- [x] ユーザーIDも併せて表示


## 機能追加: チャットID確認後のグループ登録ボタン（2026-01-28） - 完了

- [x] チャットID表示時に「このグループを登録」ボタンを表示
- [x] ボタンクリックでグループをデータベースに登録
- [x] 既に登録済みの場合は「登録済み」と表示


## 機能追加: Gemini画像生成機能（2026-01-29） - 完了

- [x] Gemini API Keyをデータベースに保存する機能
- [x] 管理画面にGemini設定タブを追加
- [x] Gemini API接続テスト機能
- [x] Telegramで「【画像生成】」トリガーを検出
- [x] Gemini APIで画像を生成
- [x] 生成した画像をTelegramに送信
- [x] エラーハンドリング（APIキー未設定、無効なプロンプト等）


## バグ修正: 画像生成中メッセージが表示されない（2026-01-29）

- [ ] 画像生成リクエスト受付時に「🎨 画像を生成中です...」メッセージを即座に送信
- [ ] 生成完了後に画像を送信


## バグ修正: 画像生成中メッセージが複数回送信される（2026-01-29）

- [x] Webhookタイムアウトによる再送信を防止
- [x] 処理中のリクエストを追跡して重複実行を防止
- [x] 即座にWebhookレスポンスを返してからバックグラウンドで処理


## 機能追加: 画像付きメッセージの画像編集機能（2026-01-29）

- [x] Telegramで画像付きメッセージ（キャプションに【画像生成】）を検出
- [x] 画像をダウンロードしてGemini APIに送信
- [x] Gemini APIで画像編集（参照画像を元に新しい画像を生成）
- [x] 編集後の画像をTelegramに送信


## 機能追加: Gemini APIを使った音声メッセージ機能（2026-01-29）

- [x] Gemini APIの音声入出力機能を調査
- [x] 音声認識サービスの実装（音声→テキスト）
- [x] 音声合成サービスの実装（テキスト→音声）
- [x] Telegram Webhookに音声メッセージ処理を追加
- [x] 管理画面に音声設定タブを追加
- [x] 音声機能の有効/無効切り替え
- [ ] テストと動作確認


## バグ修正: 音声メッセージの返事が返ってこない（2026-01-29）

- [ ] 音声ファイルダウンロード後の処理を確認
- [ ] Gemini APIへの音声送信処理を確認
- [ ] エラーハンドリングを追加してログを出力
- [ ] 音声メッセージ処理の全体フローをデバッグ


## 機能改善: ミーティング作成時のリマインダーをオプション化（2026-01-29）

- [x] ミーティング作成完了メッセージから自動リマインダー文言を削除
- [x] 「🔔 リマインダーを設定する」ボタンを追加
- [x] ボタン押下時のコールバック処理を実装
- [x] 設定画面のリマインダー時間設定を使用してリマインダーを登録


## バグ修正: ミーティング日時が確認メッセージに表示されない（2026-01-29）

- [x] ミーティング作成時の日時情報が確認メッセージに表示されるように修正（「朝3時」などのパターンを追加）


## 機能改善: ミーティング日時を具体的な日付に変換（2026-01-29）

- [x] 「朝3時」などの相対的な時間表現を具体的な日時に変換
- [x] 現在時刻から計算して、過ぎていれば翌日に設定
- [x] 「1月29日 3:00」のようなフォーマットで表示


## 次のステップ実装（2026-01-29）

### 1. 音声メッセージ機能のデバッグ
- [ ] 音声メッセージ処理のログを確認
- [ ] エラー原因を特定して修正
- [ ] 音声返答が正常に動作することを確認

### 2. リマインダー時間の選択肢を追加
- [ ] 管理画面にリマインダー時間の設定項目を追加
- [ ] 5分、10分、15分、30分、1時間の選択肢を用意

### 3. ミーティング日時に曜日を追加
- [ ] 「1月30日(木) 3:00」のように曜日を表示


## バグ修正: リマインダー日時判定がUTC時間を使用している（2026-01-29）

- [x] リマインダー設定時の日時判定をフィリピン時間（UTC+8）で行うように修正
- [x] 日時変換ロジックも同様にタイムゾーンを考慮するように修正
- [x] 「X月X日 H:MM」形式の日時パースに対応


## 機能追加: Googleカレンダー同期と表示（2026-01-29）

- [x] Google Calendar APIの調査と認証方法の確認
- [x] Google Calendar API連携サービスの実装
- [x] 管理画面にカレンダーページを追加
- [x] 月/週/日表示のカレンダービュー
- [x] 予定の一覧表示と詳細確認
- [x] イベント詳細ダイアログの実装（日時、場所、Google Meetリンク表示）
- [x] ミーティング作成時のGoogleカレンダー自動登録（日時・参加者情報付き）

## 機能追加: カレンダーイベント編集・削除機能（2026-01-29）

- [x] Googleカレンダーイベント更新APIの実装
- [x] Googleカレンダーイベント削除APIの実装
- [x] tRPCルーターに編集・削除プロシージャを追加
- [x] イベント詳細ダイアログに編集フォームを追加
- [x] イベント詳細ダイアログに削除ボタンを追加
- [x] 削除確認ダイアログの実装
- [x] UIテスト完了（編集・削除ダイアログの動作確認）

## バグ修正: タスク渡し時のメンション重複（2026-01-29）

- [x] タスク渡しメッセージでメンションが2回表示される問題を修正

## 機能追加: 期限切れタスクのリマインダー（2026-01-29）

- [x] 期限を過ぎたタスクの担当者にリマインダーを送信する機能を追加
- [x] リマインダーのスケジュール処理を実装（30分ごとにチェック）

## 機能追加: タスク完了ボタンと完了通知（2026-01-29）

- [x] 期限設定後のメッセージにタスク完了ボタンを追加
- [x] タスク完了ボタンのコールバック処理を実装
- [x] 完了時に依頼者へ通知を送信
- [x] 期限切れリマインダーにタスク完了ボタンを追加
- [x] リマインダー頻度を3時間ごとに変更

## バグ修正: タスク期限設定後のメッセージ文言修正（2026-01-29）

- [x] 期限設定後のメッセージを自然な日本語に修正
- [x] 「期限を過ぎて完了ボタンを押していない場合」にリマインダーが送られることを明確に

## 修正: タスク期限設定ボタンの整理（2026-01-29）

- [x] 「質問する」ボタンを削除
- [x] 「却下」ボタンを削除

## 機能追加: 日付指定ボタンの導線実装（2026-01-29）

- [x] 日付指定ボタンのコールバック処理を実装
- [x] ユーザーに日付入力を促すメッセージを送信
- [x] 入力された日付をパースして期限を設定（YYYY/M/D, M/D, M月D日形式対応）

## バグ修正: 対面ミーティングの場所入力後の処理（2026-01-29）

- [x] 対面ミーティングで場所入力後に反応がない問題を修正
- [x] ミーティング形式選択から「その他」ボタンを削除

## バグ修正: 対面ミーティングの日時反映と1時間前リマインダー（2026-01-29）

- [x] 対面ミーティングの日時が反映されない問題を修正（X時間後パターンを追加）
- [x] 対面ミーティングの1時間前リマインダーを実装

## バグ修正: 対面ミーティングの日時表示と不要な線の削除（2026-01-29）

- [x] 日時計算を30分刻みで四捨五入するように修正
- [x] 「対面ミーティングを選択しました」の後の不要な線を削除
- [x] 設定完了メッセージに日時を正しく表示

## バグ修正: 対面ミーティングの日時が表示されない（2026-01-29）

- [ ] 対面ミーティングの日時情報がpendingInPersonMeetingsに正しく保存されていない問題を修正

## バグ修正: ミーティング日時計算と表示形式（2026-01-29）

- [ ] 日時計算をフィリピン時間（UTC+8）で正しく行うように修正
- [ ] 時間表示を24時間形式に修正（5:30→17:30）


## 新機能: 定期タスク機能（2026-01-29）

- [x] データベースにrecurring_tasksテーブルを追加（頻度、日付、時間、タスク内容、担当者）
- [x] 【定期タスク】トリガーの検出を実装
- [x] 頻度選択ボタンの実装（毎日、毎週、毎月）
- [x] 毎週の場合は曜日選択ボタンを表示
- [x] 毎月の場合は日付入力を促す
- [x] 時間入力の処理を実装
- [x] タスク内容入力の処理を実装
- [x] 担当者（@メンション）入力の処理を実装
- [x] 定期タスクの確認メッセージを送信
- [x] 定期タスクのリマインダースケジューラーを実装
- [x] 指定時間にリマインダーを送信する機能
- [x] 管理画面に定期タスク一覧ページを追加
- [x] 定期タスクの編集・削除機能
- [x] 定期タスクの一時停止・再開機能
- [x] ユニットテストの作成と実行


## バグ修正: 【定期タスク】トリガーが反応しない（2026-01-29）

- [ ] Telegram API接続エラー（ECONNRESET）の原因を調査
- [ ] ネットワークエラー時のリトライ処理を追加
- [ ] エラーハンドリングを強化


## 機能追加: 毎日タスクの除外曜日設定（2026-01-29）

- [x] データベースにexcludeDays（除外曜日）フィールドを追加
- [x] Telegramボットの毎日タスク設定フローに除外曜日選択を追加
- [x] スケジューラーで除外曜日をチェックしてスキップ
- [x] 管理画面の定期タスク編集に除外曜日設定を追加
- [x] ユニットテストの追加と実行


## 機能追加: 定期タスク完了報告機能（2026-01-29）

- [x] データベースにrecurring_task_completions（完了履歴）テーブルを追加
- [x] リマインダーメッセージに「完了報告」ボタンを追加
- [x] 完了ボタンのコールバック処理を実装
- [x] 完了時に確認メッセージを送信
- [x] 管理画面に完了履歴ページを追加
- [x] ナビゲーションに完了履歴メニューを追加
- [x] ユニットテストの追加と実行


## 最終QAテスト（2026-01-29）

- [x] 全ユニットテストの実行と確認（100テスト全てパス）
- [x] 管理画面の全ページ動作確認
- [x] テストデータの消去（タスク、ミーティング、リマインダー、定期タスク、完了履歴、下書き）
- [x] QAレポートの作成


## SaaS化: 認証・テナント・決済システム（2026-01-29）

### Phase 1: Google OAuth認証
- [x] Google OAuth認証の実装
- [x] Manus認証との並存対応
- [x] ログイン/ログアウトフローの更新

### Phase 2: テナント機能
- [x] organizationsテーブルの追加
- [x] organization_membersテーブルの追加
- [x] ユーザーとテナントの紐付け
- [x] テナント作成・管理UI（/organizations）

### Phase 3: Telegram BOT設定
- [x] テナントごとのBOTトークン登録機能
- [x] Webhook URLの動的生成（/api/telegram/webhook/:slug）
- [x] テナント対応Webhookハンドラー

### Phase 4: Stripe決済
- [x] Stripeの統合
- [x] サブスクリプションプラン設定（スターター、プロ、エンタープライズ）
- [x] Checkout Session作成API
- [x] Customer PortalセッションAPI
- [x] Webhookハンドラー（/api/stripe/webhook）
- [x] 請求・プランページ（/billing）

### Phase 5: 仮想通貨決済
- [x] 仮想通貨決済サービスの実装
- [x] BTC, ETH, USDT, USDC対応
- [x] 決済作成・QRコード生成API
- [x] 決済確認と有効化フロー


## バグ修正: 請求ページで組織未所属ユーザーのエラー（2026-01-29）

- [x] 組織に所属していないユーザーの場合のエラーハンドリングを追加
- [x] 組織作成を促すUIを表示


## バグ修正: organization.list APIが見つからない（2026-01-29）

- [x] BillingページのAPIパスを修正（organization → organizations）


## UI整理: ユーザー向け/運営向け画面の分離（2026-01-29）

- [x] ユーザー向けナビゲーションを整理（ダッシュボード、組織管理、カレンダー連携、トリガー設定、設定、請求・プラン）
- [x] 運営専用メニューを作成（タスク一覧、定期タスク、完了履歴、ミーティング、リマインダー、下書き、監査ログ）
- [x] 運営専用ページへのアクセス制限（admin roleのみ表示）
